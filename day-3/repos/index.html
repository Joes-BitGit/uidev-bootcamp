<!DOCTYPE html>
<html lang="en">

<head>
  <title>Popular Repos</title>
  <script crossorigin src="https://unpkg.com/react@16/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
  <script src='https://unpkg.com/babel-standalone@6/babel.min.js'></script>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div id='app'></div>
  <script>
    window.API = {
      fetchPopularRepos(language) {
        // "language" can be "javascript", "ruby", "python", or "all"
        const encodedURI = encodeURI(`https://api.github.com/search/repositories?q=stars:>1+language:${language}&sort=stars&order=desc&type=Repositories`)

        return fetch(encodedURI)
          .then((data) => data.json())
          .then((repos) => repos.items)
          .catch((error) => {
            console.warn(error)
            return null
          });
      }
    }
  </script>

  <script type='text/babel'>
    function Loading() {
      const [text, setText] = React.useState('Loading');

      React.useEffect(() => {
        const stopper = text + '...';
        console.log('MOUNTING IN USEEFFECT');
        let interval = window.setInterval(() => {
          text === stopper
            ? setText('Loading')
            : setText(`${text}` + '.')
        }, 300);

        return () => {
          console.log('UNMOUNTING IN USEEFFECT');
          window.clearInterval(interval);
        }
      });

      return (
        <p>
          {text}
        </p>
      )
    }


    function RepoGrid(props) {
      return (
        <ul className='grid'>
          {props.repos.map((item) =>
            <li key={item.id}>
              <ul>
                <li>
                  <a href={item.html_url}>{item.name}</a>
                </li>
                <li>
                  <span>@{item.owner.login}</span>
                </li>
                <li>
                  <span>{item.stargazers_count}stars</span>
                </li>
              </ul>
            </li>
          )}
        </ul>
      )
    }

    function Nav(props) {
      const languages = ['all', 'javascript', 'python', 'ruby'];

      return (
        <nav>
          <ol>
            {languages.map((opts) =>
              // if i click one of these options it should update the component

              // thinking i should have an onclick event handler for each language
              // then use the component lifecycle componentDidUpdate
              <li key={opts}>
                <span onClick={() => props.onSelectLanguage(opts)}>{opts}</span>
              </li>
            )}
          </ol>
        </nav>
      )

    }


    class App extends React.Component {
      constructor(props) {
        super(props);
        this.state = {
          repos: [],
          loading: true,
          curr: 'all',
        }
        this.fetchRepos = this.fetchRepos.bind(this)
        this.handleSelectLanguage = this.handleSelectLanguage.bind(this);
      }

      componentDidMount() {
        console.log('--Mounting--');
        this.fetchRepos(this.state.curr)
      }

      componentDidUpdate(prevProps, prevState) {
        console.log('--Updating--');
        if (prevState.curr !== this.state.curr) {
          this.fetchRepos(this.state.curr)
        }
      }

      fetchRepos(lang) {

        this.setState({
          loading: true
        })


        window.API.fetchPopularRepos(lang)
          .then((data) => {
            // should update local state 
            this.setState({
              repos: data,
              loading: false,
            })
          })
      }

      handleSelectLanguage(lang) {
        this.setState({
          curr: lang
        })
      }

      render() {
        // dynamic/conditional rendering
        console.log('--render--');
        return (
          <div>
            <Nav onSelectLanguage={this.handleSelectLanguage} />
            {this.state.loading === true
              ? <Loading />
              : <RepoGrid repos={this.state.repos} />

            }
          </div>
        )
      }
    }

    ReactDOM.render(
      <App />,
      document.getElementById('app')
    )
  </script>
</body>

</html>